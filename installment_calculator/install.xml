<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Installment Calculator</name>
    <code>installment_calculator</code>
    <version>1.0.9</version>
    <author>Custom</author>
    
    <!-- ПРЯМАЯ ВСТАВКА В КОНТРОЛЛЕР ПРОДУКТА -->
    <file path="catalog/controller/product/product.php">
        <operation>
            <search><![CDATA[$data['footer'] = $this->load->controller('common/footer');]]></search>
            <add position="before"><![CDATA[
        // Installment Calculator
        $this->load->model('setting/setting');
        $inst_settings = $this->model_setting_setting->getSetting('module_installment_calculator');
        
        if (!empty($inst_settings['module_installment_calculator_status'])) {
            $months_string = !empty($inst_settings['module_installment_calculator_months']) ? $inst_settings['module_installment_calculator_months'] : '4,6,10,12';
            $months = array_map('intval', array_map('trim', explode(',', $months_string)));
            sort($months);
            
            $inst_data = array();
            $inst_data['months'] = $months;
            $inst_data['months_json'] = json_encode($months);
            $inst_data['default_month'] = end($months);
            $inst_data['price'] = isset($data['price']) ? $data['price'] : '0';
            
            $data['installment_calculator'] = $this->load->view('extension/module/installment_calculator', $inst_data);
            $data['installment_popup'] = $this->load->view('extension/module/installment_popup');
        } else {
            $data['installment_calculator'] = '';
            $data['installment_popup'] = '';
        }
            ]]></add>
        </operation>
    </file>
    
    <!-- для unishop2_free темы -->

    <!-- ВСТАВКА В ШАБЛОН unishop2_free -->
    <file path="catalog/view/theme/unishop2_free/template/product/product.twig">
        <operation>
            <search><![CDATA[{% if minimum > 1 %}]]></search>
            <add position="before"><![CDATA[
                <div class="product-data__item installment_calculator" style="margin-top:15px; width:100%; clear:both;">
                    {{ installment_calculator }}
                </div>
            ]]></add>
        </operation>
    </file>
    
    <!-- POPUP ПЕРЕД FOOTER -->
    <file path="catalog/view/theme/unishop2_free/template/product/product.twig">
        <operation>
            <search><![CDATA[{{ footer }}]]></search>
            <add position="before"><![CDATA[
{{ installment_popup }}
            ]]></add>
        </operation>
    </file>
    
    <!-- JS В HEADER - ИСПРАВЛЕНО -->
    <file path="catalog/view/theme/unishop2_free/template/common/header.twig">
        <operation>
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[
<script src="catalog/view/javascript/installment_calculator.js"></script>
            ]]></add>
        </operation>
    </file>
    
    <!-- для default темы -->

    <!-- Fallback для default темы -->
    <file path="catalog/view/theme/default/template/product/product.twig">
        <operation error="skip">
            <search><![CDATA[<button type="button" id="button-cart" data-loading-text="{{ text_loading }}" class="btn btn-primary btn-lg btn-block">{{ button_cart }}</button>]]></search>
            <add position="after"><![CDATA[
{{ installment_calculator }}
            ]]></add>
        </operation>
    </file>
    
    <!-- Fallback POPUP для default темы -->
    <file path="catalog/view/theme/default/template/product/product.twig">
        <operation error="skip">
            <search><![CDATA[{{ footer }}]]></search>
            <add position="before"><![CDATA[
{{ installment_popup }}
            ]]></add>
        </operation>
    </file>

    <!-- JS В HEADER - ИСПРАВЛЕНО -->
    <file path="catalog/view/theme/default/template/common/header.twig">
        <operation>
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[
<script src="catalog/view/javascript/installment_calculator.js"></script>
            ]]></add>
        </operation>
    </file>

</modification>
