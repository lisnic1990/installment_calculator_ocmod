<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Installment Calculator</name>
    <code>installment_calculator</code>
    <version>1.1.0</version>
    <author>Custom</author>
    
    <!-- ПРЯМАЯ ВСТАВКА В КОНТРОЛЛЕР ПРОДУКТА -->
    <file path="catalog/controller/product/product.php">
        <operation>
            <search><![CDATA[$data['footer'] = $this->load->controller('common/footer');]]></search>
            <add position="before"><![CDATA[
        // Installment Calculator - Fixed Controller Call
        $this->load->model('setting/setting');
        $inst_settings = $this->model_setting_setting->getSetting('module_installment_calculator');
        
        if (!empty($inst_settings['module_installment_calculator_status'])) {
            // Вызываем контроллер, а не view напрямую
            $data['installment_calculator'] = $this->load->controller('extension/module/installment_calculator');
            $data['installment_popup'] = $this->load->controller('extension/module/installment_calculator/popup');
        } else {
            $data['installment_calculator'] = '';
            $data['installment_popup'] = '';
        }
            ]]></add>
        </operation>
    </file>
    
    <!-- для unishop2_free темы -->

    <!-- ВСТАВКА В ШАБЛОН unishop2_free -->
    <file path="catalog/view/theme/unishop2_free/template/product/product.twig">
        <operation>
            <search><![CDATA[{% if minimum > 1 %}]]></search>
            <add position="before"><![CDATA[
                <div class="product-data__item installment_calculator" style="margin-top:15px; width:100%; clear:both;">
                    {{ installment_calculator }}
                </div>
            ]]></add>
        </operation>
    </file>
    
    <!-- POPUP ПЕРЕД FOOTER -->
    <file path="catalog/view/theme/unishop2_free/template/product/product.twig">
        <operation>
            <search><![CDATA[{{ footer }}]]></search>
            <add position="before"><![CDATA[
{{ installment_popup }}
            ]]></add>
        </operation>
    </file>
    
    <!-- JS В HEADER - ИСПРАВЛЕНО -->
    <file path="catalog/view/theme/unishop2_free/template/common/header.twig">
        <operation>
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[
<script src="catalog/view/javascript/installment_calculator.js"></script>
            ]]></add>
        </operation>
    </file>
    
    <!-- для default темы -->

    <!-- Fallback для default темы -->
    <file path="catalog/view/theme/default/template/product/product.twig">
        <operation error="skip">
            <search><![CDATA[<button type="button" id="button-cart" data-loading-text="{{ text_loading }}" class="btn btn-primary btn-lg btn-block">{{ button_cart }}</button>]]></search>
            <add position="after"><![CDATA[
{{ installment_calculator }}
            ]]></add>
        </operation>
    </file>
    
    <!-- Fallback POPUP для default темы -->
    <file path="catalog/view/theme/default/template/product/product.twig">
        <operation error="skip">
            <search><![CDATA[{{ footer }}]]></search>
            <add position="before"><![CDATA[
{{ installment_popup }}
            ]]></add>
        </operation>
    </file>

    <!-- JS В HEADER - ИСПРАВЛЕНО -->
    <file path="catalog/view/theme/default/template/common/header.twig">
        <operation>
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[
<script src="catalog/view/javascript/installment_calculator.js"></script>
            ]]></add>
        </operation>
    </file>

</modification>
